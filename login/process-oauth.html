<script>
if (!window.location.search.includes('code')) {
  console.log('no code');
}

const discordCode = window.location.search.split('=')[1];

const payload = {
  code: discordCode,
  client_id: '1052842537074823188',
  client_secret: 'R4aKN-BibX1LX9-pjjNT-NDU8H9kDvvz',
  grant_type: 'authorization_code',
  redirect_uri: 'https://www.lookoftruth.pl/stibot.github.io-main/src/process-oauth.php',
  scope: 'identify%20guids',
};

console.log(payload);

const payloadString = new URLSearchParams(payload).toString();
const discordTokenUrl = 'https://discordapp.com/api/oauth2/token';

fetch(discordTokenUrl, {
  method: 'POST',
  body: payloadString,
  headers: {
    'Content-Type': 'application/x-www-form-urlencoded',
  },
})
  .then((response) => response.json())
  .then((result) => {
    const accessToken = result.access_token;
    const discordUsersUrl = 'https://discordapp.com/api/users/@me';
    const header = {
      Authorization: `Bearer ${accessToken}`,
      'Content-Type': 'application/x-www-form-urlencoded',
    };

    return fetch(discordUsersUrl, {
      headers: header,
    });
  })
  .then((response) => response.json())
  .then((result) => {
    const guildId = '975656610431123496';
    return addUserToGuild(result.id, accessToken, guildId);
  })
  .then((result) => {
    const session = window.sessionStorage;
    session.setItem('logged_in', true);
    session.setItem('userData', JSON.stringify({
      name: result.username,
      discord_id: result.id,
      avatar: result.avatar,
      guilds: getUsersGuilds(accessToken),
    }));

    window.location.replace('dashboard.html');
  })
  .catch((error) => {
    console.error(error);
  });

async function addUserToGuild(discordId, token, guildId) {
  const payload = {
    access_token: token,
  };

  const discordApiUrl = `https://discordapp.com/api/guilds/${guildId}/members/${discordId}`;

  const botToken = 'MTA1Mjg0MjUzNzA3NDgyMzE4OA.GDDm-S.QEV59eeliNjE4Epx2mij1PnhsZC4s3k';
  const header = {
    Authorization: `Bot ${botToken}`,
    'Content-Type': 'application/x-www-form-urlencoded',
  };

  const result = await fetch(discordApiUrl, {
    method: 'PUT',
    headers: header,
    body: new URLSearchParams(payload).toString(),
  });

  return result.json();
}

async function getUsersGuilds(token) {
  const discordApiUrl = 'https://discordapp.com/api/users/@me/guilds';
  const header = {
    Authorization: `Bearer ${token}`,
    'Content-Type': 'application/x-www-form-urlencoded',
  };

  const result = await fetch(discordApiUrl, {
    headers: header,
  });

  return result.json();
}

</script>
